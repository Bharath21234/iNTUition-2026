(()=>{"use strict";var e;!function(e){e.PROCESS_COMMAND="PROCESS_COMMAND",e.COMMAND_RESULT="COMMAND_RESULT",e.GET_DOM_CONTEXT="GET_DOM_CONTEXT",e.DOM_CONTEXT_RESPONSE="DOM_CONTEXT_RESPONSE",e.EXECUTE_ACTION="EXECUTE_ACTION",e.ACTION_RESULT="ACTION_RESULT",e.CLARIFICATION_NEEDED="CLARIFICATION_NEEDED",e.CLARIFICATION_RESPONSE="CLARIFICATION_RESPONSE",e.GET_SETTINGS="GET_SETTINGS",e.SETTINGS_RESPONSE="SETTINGS_RESPONSE",e.SETTINGS_UPDATED="SETTINGS_UPDATED",e.STATUS_UPDATE="STATUS_UPDATE",e.ERROR="ERROR",e.PING="PING",e.PONG="PONG"}(e||(e={}));const t={provider:"claude",apiKey:"",intentModel:"claude-3-5-haiku-20241022",codeGenModel:"claude-sonnet-4-20250514",maxRetries:3,confirmDestructive:!0,audioFeedback:!1,theme:"system"},s=[{pattern:/^scroll\s+(down|up)(?:\s+(\d+))?$/i,action:"scroll",extractParams:e=>({direction:e[1].toLowerCase(),amount:e[2]||"400"})},{pattern:/^scroll\s+to\s+(top|bottom)$/i,action:"scroll",extractParams:e=>({direction:e[1].toLowerCase()})},{pattern:/^page\s+(down|up)$/i,action:"scroll",extractParams:e=>({direction:e[1].toLowerCase(),amount:"800"})},{pattern:/^go\s+back$/i,action:"goBack"},{pattern:/^go\s+forward$/i,action:"goForward"},{pattern:/^(refresh|reload)(\s+page)?$/i,action:"reload"},{pattern:/^(?:navigate|go|open)\s+(?:to\s+)?(?:the\s+)?(?:website\s+)?([a-zA-Z0-9][-a-zA-Z0-9]*(?:\.[a-zA-Z0-9][-a-zA-Z0-9]*)+(?:\/\S*)?)$/i,action:"navigate",extractParams:e=>({url:e[1]})},{pattern:/^(?:navigate|go|open)\s+(?:to\s+)?(https?:\/\/\S+)$/i,action:"navigate",extractParams:e=>({url:e[1]})},{pattern:/^click\s+["']([^"']+)["']$/i,action:"clickByText",extractParams:e=>({text:e[1]})},{pattern:/^click\s+on\s+["']([^"']+)["']$/i,action:"clickByText",extractParams:e=>({text:e[1]})}];async function n(e){const{provider:t,apiKey:s,model:n,systemPrompt:o,userMessage:r,maxTokens:a=1e3,temperature:i=.7}=e;if(!s)throw new Error("API key is required");switch(t){case"claude":return async function(e,t,s,n,o,r){const a=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":e,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:t,max_tokens:o,temperature:r,system:s,messages:[{role:"user",content:n}]})});if(!a.ok){const e=await a.text();throw console.error("[AIClient] Claude API error:",e),new Error(`Claude API error: ${a.status} - ${e}`)}const i=await a.json();if(!i.content||!i.content[0]||!i.content[0].text)throw new Error("Invalid response from Claude API");return i.content[0].text}(s,n,o,r,a,i);case"openai":return async function(e,t,s,n,o,r){const a=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({model:t,max_tokens:o,temperature:r,messages:[{role:"system",content:s},{role:"user",content:n}]})});if(!a.ok){const e=await a.text();throw console.error("[AIClient] OpenAI API error:",e),new Error(`OpenAI API error: ${a.status} - ${e}`)}const i=await a.json();if(!i.choices||!i.choices[0]||!i.choices[0].message)throw new Error("Invalid response from OpenAI API");return i.choices[0].message.content}(s,n,o,r,a,i);default:throw new Error(`Unknown AI provider: ${t}`)}}new class{constructor(e=10,t=6e4){this.requests=[],this.maxRequests=e,this.windowMs=t}canProceed(){const e=Date.now();return this.requests=this.requests.filter(t=>e-t<this.windowMs),!(this.requests.length>=this.maxRequests||(this.requests.push(e),0))}getWaitTime(){return this.requests.length<this.maxRequests?0:Math.min(...this.requests)+this.windowMs-Date.now()}}(10,6e4);const o=[{pattern:/fetch\s*\(/gi,reason:"Network requests are not allowed"},{pattern:/XMLHttpRequest/gi,reason:"Network requests are not allowed"},{pattern:/\.ajax\s*\(/gi,reason:"Network requests are not allowed"},{pattern:/axios\./gi,reason:"Network requests are not allowed"},{pattern:/navigator\.sendBeacon/gi,reason:"Network requests are not allowed"},{pattern:/WebSocket/gi,reason:"WebSocket connections are not allowed"},{pattern:/document\.cookie/gi,reason:"Cookie access is not allowed"},{pattern:/localStorage/gi,reason:"localStorage access is not allowed"},{pattern:/sessionStorage/gi,reason:"sessionStorage access is not allowed"},{pattern:/indexedDB/gi,reason:"IndexedDB access is not allowed"},{pattern:/caches\./gi,reason:"Cache API access is not allowed"},{pattern:/eval\s*\(/gi,reason:"eval() is not allowed"},{pattern:/Function\s*\(/gi,reason:"Function constructor is not allowed"},{pattern:/setTimeout\s*\(\s*['"`]/gi,reason:"setTimeout with string argument is not allowed"},{pattern:/setInterval\s*\(\s*['"`]/gi,reason:"setInterval with string argument is not allowed"},{pattern:/<script/gi,reason:"Script injection is not allowed"},{pattern:/javascript:/gi,reason:"javascript: URLs are not allowed"},{pattern:/data:text\/html/gi,reason:"data: HTML URLs are not allowed"},{pattern:/chrome\.\w+/gi,reason:"Chrome extension APIs are not allowed in injected code"},{pattern:/browser\.\w+/gi,reason:"Browser APIs are not allowed in injected code"}],r=[{pattern:/\b(pay|purchase|buy|checkout|order|subscribe|billing)\b/gi,message:"This action involves a payment or purchase"},{pattern:/\b(delete|remove|cancel|unsubscribe|close\s*account|deactivate)\b/gi,message:"This action may delete or remove data"},{pattern:/\b(password|credit\s*card|ssn|social\s*security)\b/gi,message:"This action involves sensitive data"},{pattern:/\.submit\s*\(\s*\)/gi,message:"This action will submit a form"}];function a(e,t){for(const{pattern:t,reason:s}of o)if(t.lastIndex=0,t.test(e))return{safe:!1,blocked:e.match(t)?.[0]||"unknown",blockedReason:s};const s=[];for(const{pattern:t,message:n}of r)t.lastIndex=0,t.test(e)&&s.push(n);return s.length>0?{safe:!0,requiresConfirmation:!0,confirmationMessage:`This action has been flagged for review:\n- ${s.join("\n- ")}\n\nDo you want to proceed?`,flaggedPatterns:s}:{safe:!0}}async function i(e,t){try{switch(console.log("[Executor] Executing action:",e.actionType,e.selector),e.actionType){case"click":return async function(e,t){const s=await chrome.scripting.executeScript({target:{tabId:t},func:e=>{const t=window.__aiAgentElementMap;let s=t?.get(e);if(!s&&e&&(s=document.querySelector(e)),!s&&e){const t=document.querySelectorAll('button, a, [role="button"], input[type="submit"]');for(const n of t)if(n.textContent?.toLowerCase().includes(e.toLowerCase())){s=n;break}}if(!s)return{success:!1,error:`Element not found: ${e}`};s.scrollIntoView({behavior:"smooth",block:"center"});const n=s,o=n.style.outline;return n.style.outline="3px solid #4CAF50",setTimeout(()=>{n.style.outline=o,n.click()},300),{success:!0}},args:[e]}),n=s[0]?.result;return n?.success?{success:!0,message:`Clicked ${e}`}:{success:!1,error:n?.error||"Click failed"}}(e.selector||"",t);case"fill":return async function(e,t,s){const n=await chrome.scripting.executeScript({target:{tabId:s},func:(e,t)=>{const s=window.__aiAgentElementMap;let n=s?.get(e)||document.querySelector(e);return n||(n=document.querySelector(`input[placeholder*="${e}" i], input[name*="${e}" i], textarea[placeholder*="${e}" i]`)),n&&(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement)?(n.focus(),n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0}):{success:!1,error:`Input not found: ${e}`}},args:[e,t]}),o=n[0]?.result;return o?.success?{success:!0,message:`Filled ${e}`}:{success:!1,error:o?.error||"Fill failed"}}(e.selector||"",e.code,t);case"scroll":return async function(e,t){return await chrome.scripting.executeScript({target:{tabId:t},func:e=>{switch(e.toLowerCase()){case"down":window.scrollBy({top:400,behavior:"smooth"});break;case"up":window.scrollBy({top:-400,behavior:"smooth"});break;case"top":window.scrollTo({top:0,behavior:"smooth"});break;case"bottom":window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}},args:[e]}),{success:!0,message:`Scrolled ${e}`}}(e.code,t);case"navigate":return async function(e,t){let s=e.trim();return s.startsWith("http://")||s.startsWith("https://")||(s="https://"+s),await chrome.tabs.update(t,{url:s}),{success:!0,message:`Navigating to ${s}`}}(e.code,t);case"extract":return async function(e,t){const s=await chrome.scripting.executeScript({target:{tabId:t},func:e=>{const t=document.querySelector(e)||document.body;return{text:t.innerText?.slice(0,1e3)}},args:[e]}),n=s[0]?.result;return{success:!0,message:n?.text||"No content extracted"}}(e.selector||"",t);case"modify":return async function(e,t){return await chrome.scripting.executeScript({target:{tabId:t},func:e=>{try{const t=JSON.parse(e),s="ai-agent-mod-"+Date.now();let n="";if("enlarge-text"===t.type?n=`body * { font-size: ${t.scale||1.2}em !important; }`:"bold-text"===t.type?n="body p, body span, body div { font-weight: 600 !important; }":"high-contrast"===t.type?n="body { filter: contrast(1.2) !important; }":t.css&&(n=t.css),n){const e=document.createElement("style");e.id=s,e.textContent=n,document.head.appendChild(e)}}catch{const t=document.createElement("style");t.id="ai-agent-mod-"+Date.now(),t.textContent=e,document.head.appendChild(t)}},args:[e]}),{success:!0,message:"Style applied"}}(e.code,t);default:return async function(e,t){try{const s=await chrome.scripting.executeScript({target:{tabId:t},func:e=>{try{return new Function(e)(),{success:!0}}catch(e){return{success:!1,error:e.message}}},args:[e]}),n=s[0]?.result;return n?.success?{success:!0,message:"Code executed"}:{success:!1,error:n?.error||"Execution failed"}}catch(e){return{success:!1,error:"Code execution blocked"}}}(e.code,t)}}catch(e){return console.error("[Executor] Action execution error:",e),{success:!1,error:e instanceof Error?e.message:"Execution failed"}}}async function c(e,t){if(!e||"none"===e.type)return{success:!0,expectedResult:"No verification needed",actualResult:"Skipped"};await new Promise(e=>setTimeout(e,300));try{if("navigation"===e.type){if(!e.expectedResult)return{success:!0,expectedResult:"any",actualResult:"Navigation initiated"};const s=await chrome.tabs.get(t),n=s.url?.toLowerCase()||"",o=e.expectedResult.toLowerCase();return{success:n.includes(o)||"loading"===s.status,expectedResult:e.expectedResult,actualResult:s.url||"loading"}}return{success:!0,expectedResult:e.expectedResult||"Change applied",actualResult:"Verified"}}catch(t){return console.warn("[Executor] Verification check failed:",t),{success:!0,expectedResult:e.expectedResult||"unknown",actualResult:"Verification skipped due to error"}}}function l(){const e=[];let t=0;const s=new Map;document.querySelectorAll(["a[href]","button","input","select","textarea",'[role="button"]','[role="link"]',"[onclick]"].join(",")).forEach(n=>{const o=n.getBoundingClientRect(),r=window.getComputedStyle(n);if(o.width>0&&o.height>0&&"none"!==r.display&&"hidden"!==r.visibility&&o.top<window.innerHeight){const r="el-"+t++;s.set(r,n),e.push({id:r,tagName:n.tagName.toLowerCase(),text:(n.textContent||"").trim().slice(0,100),attributes:{id:n.id||void 0,href:n.getAttribute("href")||void 0,type:n.getAttribute("type")||void 0,placeholder:n.getAttribute("placeholder")||void 0,ariaLabel:n.getAttribute("aria-label")||void 0,name:n.getAttribute("name")||void 0},isInteractive:!0,boundingBox:{x:Math.round(o.x),y:Math.round(o.y),width:Math.round(o.width),height:Math.round(o.height)}})}}),window.__aiAgentElementMap=s;const n=document.querySelector("main, article")||document.body;return{url:window.location.href,title:document.title,timestamp:Date.now(),elements:e,pageText:n.innerText?.slice(0,2e3)||""}}async function u(e,t,o,r){const u={stage:"idle",command:e};try{if(!(d=(await chrome.tabs.get(t)).url)||!d.startsWith("http://")&&!d.startsWith("https://"))return await chrome.tabs.update(t,{url:"https://www.google.com"}),{success:!0,message:"Navigated to Google. You can now give me commands to interact with the page."};u.stage="fast-path";const p=function(e){const t=e.trim();for(const e of s){const s=t.match(e.pattern);if(s){const t=e.extractParams?e.extractParams(s):{};return{matched:!0,action:e.action,params:t}}}return{matched:!1}}(e);if(p.matched){console.log("[Pipeline] Fast-path matched:",p.action);const e=await async function(e,t,s){try{switch(e){case"scroll":return async function(e,t){const{direction:s,amount:n}=e,o=parseInt(n||"400",10);return await chrome.scripting.executeScript({target:{tabId:t},func:(e,t)=>{switch(e){case"down":window.scrollBy({top:t,behavior:"smooth"});break;case"up":window.scrollBy({top:-t,behavior:"smooth"});break;case"top":window.scrollTo({top:0,behavior:"smooth"});break;case"bottom":window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}return{success:!0}},args:[s,o]}),{success:!0,message:`Scrolled ${s}`}}(t,s);case"goBack":return async function(e){return await chrome.scripting.executeScript({target:{tabId:e},func:()=>{window.history.back()}}),{success:!0,message:"Navigated back"}}(s);case"goForward":return async function(e){return await chrome.scripting.executeScript({target:{tabId:e},func:()=>{window.history.forward()}}),{success:!0,message:"Navigated forward"}}(s);case"reload":return async function(e){return await chrome.tabs.reload(e),{success:!0,message:"Page reloaded"}}(s);case"navigate":return async function(e,t){let{url:s}=e;return s.startsWith("http://")||s.startsWith("https://")||(s="https://"+s),await chrome.tabs.update(t,{url:s}),{success:!0,message:`Navigating to ${s}`}}(t,s);case"clickByText":return async function(e,t){const{text:s}=e,n=await chrome.scripting.executeScript({target:{tabId:t},func:e=>{const t=document.querySelectorAll('button, a, [role="button"], input[type="submit"], input[type="button"]');for(const s of t){const t=s.textContent?.trim()||"",n=s.getAttribute("aria-label")||"",o=s.value||"";if(t.toLowerCase()===e.toLowerCase()||n.toLowerCase()===e.toLowerCase()||o.toLowerCase()===e.toLowerCase()){s.scrollIntoView({behavior:"smooth",block:"center"});const e=s,t=e.style.outline;return e.style.outline="3px solid #4CAF50",setTimeout(()=>{e.style.outline=t},500),setTimeout(()=>{s.click()},300),{success:!0,found:!0}}}return{success:!1,found:!1,error:`No element found with text "${e}"`}},args:[s]}),o=n[0]?.result;return o?.found?{success:!0,message:`Clicked "${s}"`}:{success:!1,error:o?.error||`Could not find element with text "${s}"`}}(t,s);default:return{success:!1,error:`Unknown fast-path action: ${e}`}}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Fast-path execution failed"}}}(p.action,p.params||{},t);return{success:e.success,message:e.message||"Action completed"}}u.stage="intent";const m=await async function(e){try{const t=await chrome.scripting.executeScript({target:{tabId:e},func:l}),s=t[0]?.result;if(!s)throw new Error("Failed to get DOM context");return s}catch(e){throw console.error("[Executor] Failed to get DOM context:",e),e}}(t);u.domContext=m,r.setDOMContext(m);const h=await async function(e,t,s){const o=t.elements.filter(e=>e.isInteractive).map(e=>{const t=[];return e.attributes.ariaLabel&&t.push(`aria-label="${e.attributes.ariaLabel}"`),e.attributes.placeholder&&t.push(`placeholder="${e.attributes.placeholder}"`),e.attributes.type&&t.push(`type="${e.attributes.type}"`),e.attributes.href&&t.push(`href="${e.attributes.href.slice(0,50)}..."`),`[${e.id}] <${e.tagName}${t.length?" "+t.join(" "):""}> "${e.text.slice(0,50)}"`}).join("\n"),r=`Page: ${t.title}\nURL: ${t.url}\n\nInteractive elements on page:\n${o||"No interactive elements found"}\n\nUser command: "${e}"\n\nAnalyze if this command is clear and unambiguous. If there are multiple possible targets, ask for clarification.`;try{const t=await n({provider:s.provider,apiKey:s.apiKey,model:s.intentModel,systemPrompt:'You are an intent analyzer for a browser automation assistant. Your job is to determine if a user\'s command is clear enough to execute, or if clarification is needed.\n\nAnalyze the user\'s command against the current page context (DOM elements). Determine:\n1. Is the intent clear and unambiguous?\n2. Can you identify the exact target element(s)?\n3. Are there multiple possible interpretations?\n\nRespond with a JSON object:\n{\n  "clear": boolean,\n  "clarificationQuestion": string | null,  // Question to ask if unclear\n  "clarificationOptions": string[] | null, // Options to present to user\n  "parsedIntent": {\n    "action": "click" | "fill" | "scroll" | "navigate" | "extract" | "modify",\n    "target": string,  // Element ID or description\n    "value": string | null  // For fill actions\n  } | null\n}\n\nExamples of when to ask for clarification:\n- "Click submit" but there are multiple submit buttons\n- "Fill the form" but there are multiple forms\n- Ambiguous element references\n\nExamples of clear commands:\n- "Click the blue Sign In button" (specific description)\n- "Fill the email field with test@example.com" (specific target and value)\n- "Scroll down" (simple action)',userMessage:r,maxTokens:500}),o=t.match(/\{[\s\S]*\}/);if(!o)return console.error("[IntentLLM] Failed to parse response:",t),{clear:!0,parsedIntent:{action:"click",target:e}};const a=JSON.parse(o[0]);return{clear:a.clear,clarificationQuestion:a.clarificationQuestion,clarificationOptions:a.clarificationOptions,parsedIntent:a.parsedIntent}}catch(t){return console.error("[IntentLLM] Error:",t),{clear:!0,parsedIntent:{action:"click",target:e}}}}(e,m,o);if(u.intentResult=h,!h.clear)return u.stage="clarification",{success:!0,message:h.clarificationQuestion||"Could you please clarify your request?",requiresClarification:!0,clarificationQuestion:h.clarificationQuestion,clarificationOptions:h.clarificationOptions};u.stage="codegen";const g=await async function(e,t,s,o,r){const a=s.elements.map(e=>{const t=[];e.attributes.id&&t.push(`id="${e.attributes.id}"`),e.attributes.className&&t.push(`class="${e.attributes.className.slice(0,50)}"`),e.attributes.ariaLabel&&t.push(`aria-label="${e.attributes.ariaLabel}"`),e.attributes.placeholder&&t.push(`placeholder="${e.attributes.placeholder}"`),e.attributes.type&&t.push(`type="${e.attributes.type}"`),e.attributes.name&&t.push(`name="${e.attributes.name}"`),e.attributes.href&&t.push(`href="${e.attributes.href.slice(0,80)}"`);const s=`(${e.boundingBox.x},${e.boundingBox.y} ${e.boundingBox.width}x${e.boundingBox.height})`;return`[${e.id}] <${e.tagName} ${t.join(" ")}> "${e.text.slice(0,80)}" ${e.isInteractive?"(interactive)":""} ${s}`}).join("\n"),i=r.slice(-5).map(e=>`${e.role}: ${e.content}`).join("\n"),c=`Page: ${s.title}\nURL: ${s.url}\n\nPage text summary:\n${s.pageText.slice(0,500)}...\n\nDOM Elements:\n${a}\n\nRecent conversation:\n${i||"None"}\n\nUser command: "${e}"\nParsed intent: ${JSON.stringify(t)}\n\nGenerate the JavaScript code to accomplish this task. Use the element IDs (like "el-5") to reference elements when possible.`;try{const e=await n({provider:o.provider,apiKey:o.apiKey,model:o.codeGenModel,systemPrompt:'You are a browser automation assistant. Generate structured actions to accomplish user tasks on web pages.\n\nYou receive:\n1. The user\'s command and parsed intent\n2. A simplified DOM context with interactive elements (each has an ID like "el-5")\n3. Recent conversation history for context\n\nResponse format (JSON):\n{\n  "success": true,\n  "explanation": "Brief explanation of what the action does",\n  "actions": [\n    {\n      "actionType": "click" | "fill" | "scroll" | "navigate" | "extract" | "modify",\n      "selector": "element ID (e.g., \'el-5\') or CSS selector",\n      "code": "action-specific value (see below)",\n      "description": "Human-readable description",\n      "verification": {\n        "type": "domChange" | "navigation" | "styleChange" | "none",\n        "expectedResult": "What to check for success"\n      }\n    }\n  ]\n}\n\nAction types and their fields:\n\n1. "click" - Click an element\n   - selector: Element ID (e.g., "el-5") or CSS selector or text to match\n   - code: Not used (can be empty string)\n\n2. "fill" - Fill a text input or textarea\n   - selector: Element ID or CSS selector for the input\n   - code: The value to fill in\n\n3. "scroll" - Scroll the page\n   - selector: Not used\n   - code: Direction - one of: "up", "down", "top", "bottom"\n\n4. "navigate" - Navigate to a URL\n   - selector: Not used\n   - code: The URL to navigate to (e.g., "youtube.com" or "https://google.com")\n\n5. "extract" - Extract text content from an element\n   - selector: CSS selector for the element to extract from\n   - code: Not used\n\n6. "modify" - Apply CSS style modifications\n   - selector: Not used\n   - code: JSON config like {"type": "enlarge-text", "scale": 1.5} or raw CSS string\n\nImportant:\n- Use element IDs from the DOM context when available (e.g., "el-5")\n- For clicks, prefer element IDs, then CSS selectors, then text content matching\n- Return success: false if the task cannot be accomplished\n- Do NOT generate JavaScript code - only structured actions',userMessage:c,maxTokens:2e3}),t=e.match(/\{[\s\S]*\}/);if(!t)return console.error("[CodeGenLLM] Failed to parse response:",e),{success:!1,actions:[],explanation:"Failed to parse code generation response",error:"Invalid response format"};const s=JSON.parse(t[0]);if(!s.success)return{success:!1,actions:[],explanation:s.explanation||"Code generation failed",error:s.error||"Unknown error"};const r=[];for(const e of s.actions||[])e.actionType?r.push({code:e.code,selector:e.selector||null,actionType:e.actionType,description:e.description||"Action",verification:e.verification||{type:"none",expectedResult:""}}):console.warn("[CodeGenLLM] Invalid action (missing actionType):",e);return{success:r.length>0,actions:r,explanation:s.explanation||"Generated actions"}}catch(e){return console.error("[CodeGenLLM] Error:",e),{success:!1,actions:[],explanation:"Code generation failed",error:e instanceof Error?e.message:"Unknown error"}}}(e,h.parsedIntent,m,o,r.getConversationContext());if(u.codeGenResult=g,!g.success)return{success:!1,message:g.error||"Failed to generate action code"};u.stage="safety";for(const e of g.actions){const t=a(e.code,e.actionType);if(u.safetyResult=t,!t.safe){if(t.blocked)return{success:!1,message:`Action blocked for safety: ${t.blockedReason}`};t.requiresConfirmation&&console.log("[Pipeline] Action requires confirmation:",t.confirmationMessage)}}u.stage="execution";const f=[];let w=!0;const y=[];for(const e of g.actions){let s=0;const n=o.maxRetries;let a;for(;s<n;){s++;const o=await i(e,t);if(o.success){u.stage="verification";const s=await c(e.verification,t);if(s.success){f.push({type:e.actionType,target:e.selector,description:e.description}),y.push(e.description),r.recordAction({type:e.actionType,description:e.description},!0);break}a=`Verification failed: ${s.details}`}else a=o.error;s<n&&(console.log(`[Pipeline] Retry ${s}/${n}: ${a}`),await new Promise(e=>setTimeout(e,500)))}s>=n&&a&&(w=!1,y.push(`Failed: ${e.description} (${a})`),r.recordAction({type:e.actionType,description:e.description},!1))}return u.stage="complete",{success:w,message:y.join(". ")||"Actions completed",actions:f}}catch(e){return u.stage="error",u.error=e instanceof Error?e.message:"Unknown error",console.error("[Pipeline] Error:",e),{success:!1,message:`Pipeline error: ${u.error}`}}var d}class d{constructor(e){this.session=e}get id(){return this.session.id}get tabId(){return this.session.tabId}get messages(){return this.session.messages}get domContext(){return this.session.domContext}get pendingClarification(){return this.session.pendingClarification}addMessage(e){this.session.messages.push(e),this.session.messages.length>100&&(this.session.messages=this.session.messages.slice(-50))}setDOMContext(e){this.session.domContext=e}recordAction(e,t){this.session.actionHistory.push({action:e,success:t,timestamp:Date.now()}),this.session.actionHistory.length>50&&(this.session.actionHistory=this.session.actionHistory.slice(-30))}setClarification(e){this.session.pendingClarification=e}clearClarification(){this.session.pendingClarification=null}getRecentActions(e=5){return this.session.actionHistory.slice(-e)}getConversationContext(e=10){return this.session.messages.slice(-e)}}const p=new class{constructor(){this.sessions=new Map,this.maxSessions=50,this.sessionTimeout=18e5}getOrCreateSession(e){let t=this.sessions.get(e);return t?t.lastActivityAt=Date.now():(t={id:crypto.randomUUID(),tabId:e,messages:[],domContext:null,actionHistory:[],pendingClarification:null,createdAt:Date.now(),lastActivityAt:Date.now()},this.sessions.set(e,t),this.cleanupOldSessions()),new d(t)}getSession(e){const t=this.sessions.get(e);return t?(t.lastActivityAt=Date.now(),new d(t)):null}removeSession(e){this.sessions.delete(e)}cleanupOldSessions(){const e=Date.now();for(const[t,s]of this.sessions)e-s.lastActivityAt>this.sessionTimeout&&this.sessions.delete(t);if(this.sessions.size>this.maxSessions){const e=[...this.sessions.entries()].sort((e,t)=>e[1].lastActivityAt-t[1].lastActivityAt).slice(0,this.sessions.size-this.maxSessions);for(const[t]of e)this.sessions.delete(t)}}};let m=t;async function h(){try{const e=await chrome.storage.local.get(["provider","apiKey","intentModel","codeGenModel","maxRetries","confirmDestructive","audioFeedback","theme"]);m={...t,...e},console.log("[Background] Settings loaded")}catch(e){console.error("[Background] Failed to load settings:",e)}}chrome.runtime.onInstalled.addListener(async()=>{console.log("[Background] Extension installed"),await h(),chrome.sidePanel&&chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0})}),chrome.runtime.onStartup.addListener(async()=>{console.log("[Background] Extension started"),await h()}),chrome.runtime.onMessage.addListener((t,s,n)=>(async function(t,s){const n=s.tab?.id;switch(console.log("[Background] Received message:",t.type),t.type){case e.PING:return{success:!0,data:"pong"};case e.PROCESS_COMMAND:return async function(e,t){const{command:s}=e.payload,n=e.payload.tabId||t;if(!n)return{success:!1,error:"No tab ID available"};if(m.apiKey||await h(),!m.apiKey)return{success:!1,error:"API key not configured. Please set up your API key in the extension settings."};try{const e=p.getOrCreateSession(n);e.addMessage({id:crypto.randomUUID(),role:"user",content:s,timestamp:Date.now()});const t=await u(s,n,m,e);return e.addMessage({id:crypto.randomUUID(),role:"assistant",content:t.message,timestamp:Date.now(),actions:t.actions,isError:!t.success}),{success:t.success,data:{message:t.message,actions:t.actions,requiresClarification:t.requiresClarification,clarificationQuestion:t.clarificationQuestion}}}catch(e){return console.error("[Background] Pipeline error:",e),{success:!1,error:e instanceof Error?e.message:"Pipeline processing failed"}}}(t,n);case e.CLARIFICATION_RESPONSE:return async function(e,t){if(!t)return{success:!1,error:"No tab ID available"};const s=p.getSession(t);return s?(s.setClarification(e.payload.answer),{success:!0}):{success:!1,error:"No active session found"}}(t,n);case e.GET_SETTINGS:return{success:!0,data:m};case e.SETTINGS_UPDATED:return await h(),{success:!0};default:return{success:!1,error:`Unknown message type: ${t.type}`}}}(t,s).then(n).catch(e=>{console.error("[Background] Message handling error:",e),n({success:!1,error:e instanceof Error?e.message:"Unknown error"})}),!0))})();