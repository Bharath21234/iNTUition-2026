(()=>{"use strict";var e;function t(e,t){n(e);const o=document.createElement("style");return o.id=e,o.textContent=t,document.head.appendChild(o),{success:!0,data:{styleId:e}}}function n(e){document.getElementById(e)?.remove()}!function(e){e.PROCESS_COMMAND="PROCESS_COMMAND",e.COMMAND_RESULT="COMMAND_RESULT",e.GET_DOM_CONTEXT="GET_DOM_CONTEXT",e.DOM_CONTEXT_RESPONSE="DOM_CONTEXT_RESPONSE",e.EXECUTE_ACTION="EXECUTE_ACTION",e.ACTION_RESULT="ACTION_RESULT",e.CLARIFICATION_NEEDED="CLARIFICATION_NEEDED",e.CLARIFICATION_RESPONSE="CLARIFICATION_RESPONSE",e.GET_SETTINGS="GET_SETTINGS",e.SETTINGS_RESPONSE="SETTINGS_RESPONSE",e.SETTINGS_UPDATED="SETTINGS_UPDATED",e.STATUS_UPDATE="STATUS_UPDATE",e.ERROR="ERROR",e.PING="PING",e.PONG="PONG"}(e||(e={})),chrome.runtime.onMessage.addListener((o,r,s)=>(async function(o){switch(console.log("[Content] Received message:",o.type),o.type){case e.PING:return{success:!0,data:"pong"};case e.GET_DOM_CONTEXT:return function(){try{return{success:!0,data:function(){const e=[];let t=0;const n=new Map;return document.querySelectorAll(["a[href]","button","input","select","textarea",'[role="button"]','[role="link"]','[role="checkbox"]',"[onclick]",'[tabindex]:not([tabindex="-1"])'].join(",")).forEach(o=>{if(function(e){const t=e.getBoundingClientRect(),n=window.getComputedStyle(e);return t.width>0&&t.height>0&&"none"!==n.display&&"hidden"!==n.visibility&&t.top<window.innerHeight&&t.bottom>0}(o)){const r="el-"+t++;n.set(r,o),e.push(function(e,t){const n=e.getBoundingClientRect();return{id:t,tagName:e.tagName.toLowerCase(),role:e.getAttribute("role"),text:(e.textContent||"").trim().slice(0,100),attributes:{id:e.id||void 0,className:e.className||void 0,href:e.getAttribute("href")||void 0,type:e.getAttribute("type")||void 0,placeholder:e.getAttribute("placeholder")||void 0,ariaLabel:e.getAttribute("aria-label")||void 0,name:e.getAttribute("name")||void 0},isInteractive:!0,isVisible:!0,boundingBox:{x:Math.round(n.x),y:Math.round(n.y),width:Math.round(n.width),height:Math.round(n.height)}}}(o,r))}}),window.__aiAgentElementMap=n,{url:window.location.href,title:document.title,timestamp:Date.now(),elements:e,pageText:((document.querySelector('main, article, [role="main"]')||document.body).innerText||"").slice(0,2e3)}}()}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to parse DOM"}}}();case e.EXECUTE_ACTION:return async function(e){try{const{type:o,target:r,value:s}=e;switch(o){case"click":return function(e){const t=window.__aiAgentElementMap;let n=t?.get(e);if(n||(n=document.querySelector(e)),!n)return{success:!1,error:`Element not found: ${e}`};n.scrollIntoView({behavior:"smooth",block:"center"});const o=n,r=o.style.outline;return o.style.outline="3px solid #4CAF50",setTimeout(()=>{o.style.outline=r,o.click()},300),{success:!0,data:{clicked:e}}}(r);case"fill":return function(e,t){const n=window.__aiAgentElementMap;let o=n?.get(e)||document.querySelector(e);return o?o instanceof HTMLInputElement||o instanceof HTMLTextAreaElement?(o.focus(),o.value=t,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,data:{filled:e,value:t}}):{success:!1,error:"Element is not a form field"}:{success:!1,error:`Element not found: ${e}`}}(r,s);case"scroll":return function(e){const t="string"==typeof e?e:e?.direction,n=e?.amount||400;switch(t){case"down":window.scrollBy({top:n,behavior:"smooth"});break;case"up":window.scrollBy({top:-n,behavior:"smooth"});break;case"top":window.scrollTo({top:0,behavior:"smooth"});break;case"bottom":window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"});break;default:return{success:!1,error:`Unknown scroll direction: ${t}`}}return{success:!0,data:{scrolled:t}}}(s);case"modify":return function(e){const{type:o,selector:r,scale:s,enabled:c}=e;switch(o){case"enlarge-text":return t("ai-agent-enlarge",`\n        ${r||"body"} { font-size: ${s||1.5}em !important; }\n      `);case"bold-text":return t("ai-agent-bold",`\n        ${r||"body"} p, ${r||"body"} span { font-weight: 600 !important; }\n      `);case"high-contrast":return!1!==c?t("ai-agent-contrast","\n          body { filter: contrast(1.2) !important; }\n          a { color: #0000EE !important; text-decoration: underline !important; }\n        "):(n("ai-agent-contrast"),{success:!0});case"highlight-links":return!1!==c?t("ai-agent-links","\n          a[href] { background-color: rgba(255,255,0,0.3) !important; padding: 2px 4px !important; }\n        "):(n("ai-agent-links"),{success:!0});case"reset":return document.querySelectorAll('style[id^="ai-agent-"]').forEach(e=>e.remove()),{success:!0,data:{reset:!0}};default:return{success:!1,error:`Unknown modification type: ${o}`}}}(s);default:return{success:!1,error:`Unknown action type: ${o}`}}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Action execution failed"}}}(o.payload);default:return{success:!1,error:`Unknown message type: ${o.type}`}}}(o).then(s).catch(e=>{console.error("[Content] Message handling error:",e),s({success:!1,error:e instanceof Error?e.message:"Unknown error"})}),!0)),console.log("[AI Browser Agent] Content script loaded")})();